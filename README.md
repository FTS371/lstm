# lstm
代码没有提供数据和api的token，需要数据请联系我
本项目采用了混合研究法，即结合定量研究和定性研究的方法，对股票市场数据进行预测和分析。具体的研究方法和思路如下：
1、数据收集：本项目使用了alphavantage.co网站和akshare库，从网络上获取了股票市场的历史数据，包括股票价格、成交量、市盈率等指标。同时，本项目也使用了nltk库，从网络上获取了股票市场的情感数据，包括新闻、评论、社交媒体等来源的文本数据。
2、数据预处理：本项目对收集到的数据进行了一些必要的预处理，如去除缺失值、异常值、重复值等。同时，本项目也对情感数据进行了分词、去停用词、词性标注等操作，以便后续的分析。
3、数据建模：本项目使用了CNN、RNN、GRU、LSTM和Transformer等多种深度学习模型，对股票市场数据进行建模和预测。具体地，本项目将股票价格作为因变量，将其他指标作为自变量，构建了多元回归模型。同时，本项目也将情感数据作为自变量，构建了情感分析模型。本项目使用了TensorFlow和PyTorch等深度学习框架，实现了这些模型的搭建和训练。
4、数据评估：本项目使用了RMSE、MAE、R2和相关系数等4个指标参数，对不同深度学习模型的预测效果进行评估和比较。同时，本项目也使用了混淆矩阵、准确率、召回率、F1值等指标参数，对情感分析模型的分类效果进行评估和比较。
5、数据分析：本项目使用了莫伦卡选股模型和akshare库，对股票进行基本面分析，以识别股票价格变动的基本面因素。具体地，本项目使用了莫伦卡选股模型中的五个指标（市盈率、市净率、净利润增长率、净资产收益率、资产负债率），对股票进行打分和排序，并选取前10%的股票作为优质股票。同时，本项目也使用了akshare库中的多个函数（如get_stock_financial_report_sina等），获取了股票的财务报表数据，并进行了一些统计分析。
3.1 数据来源和获取
本文的数据来源主要包括两个方面：股票市场历史数据和股票市场情感数据。股票市场历史数据主要来自于AlphaVantage网站、akshare库和tushare接口，而股票市场情感数据则主要来自于网络上的新闻、评论、社交媒体等来源的文本数据。
股票市场历史数据的获取主要依赖于AlphaVantage网站、akshare库和tushare接口。AlphaVantage是一个提供股票市场历史数据的网站，可以免费获取全球股票市场的历史数据，包括股票价格、成交量、市盈率等指标。akshare库和tushare接口则是基于Python语言的股票市场数据获取工具，可以方便地获取股票市场历史数据，并将其转化为可供分析的数据格式。通过这些工具的使用，我们可以获取股票市场历史数据，并进行分析和建模。
股票市场情感数据的获取则主要依赖于nltk库，该库是自然语言处理领域的一个常用工具包，可以通过网络爬虫获取网络上的文本数据，并进行情感分析。在本项目中，我们主要从网络上爬取股票市场相关的新闻、评论、社交媒体等文本数据，并利用nltk库进行情感分析，以获取股票市场的情感数据。这些数据可以帮助我们了解股票市场参与者的情感状态，对股票市场的分析和预测具有重要意义。
3.2 数据清洗和预处理
在本研究中，使用了股票市场的历史价格和基本面指标数据，以预测未来的股票价格波动。使用了Python编程语言和相关的数据处理和机器学习库来处理和分析数据。以下是数据清理和预处理步骤：
数据获取：使用Akshare库来获取上海证券交易所的股票历史数据，包括开盘价、收盘价、最高价、最低价、成交量系数等。选择的股票代码分别是000001、000300、600104。
数据清洗：删除缺失值和重复行。
 date        close        macd       ...  volatility    volume      cncci
2007-01-31  2818.960300  157.362886  ...    0.037065  1.158864e+10  112.4
2007-02-28  2810.683667   58.957850  ...    0.034226  9.817714e+09  111.8
2007-03-31  2990.483636   55.654940  ...    0.025461  1.107411e+10  111.0
2007-04-30  3537.115619  141.577065  ...    0.023496  1.386157e+10  112.3
2007-05-31  4083.424333  185.693972  ...    0.030480  1.619006e+10  112.8
..          ...          ...         ...  ...         ...           ...    ...
2022-10-31  3006.106063  -47.168235  ...    0.016604  2.586646e+10   86.8
2022-11-30  3079.397318   -3.495732  ...    0.013349  3.122308e+10   85.5
2022-12-31  3135.425455   15.522367  ...    0.009156  2.791060e+10   88.3
2023-01-31  3195.336938   14.965310  ...    0.008274  2.583395e+10   91.2
2023-02-28  3269.761350   29.801473  ...    0.010114  2.813725e+10   94.7
表3.1 数据集快照
数据转换：将日期列转换为时间戳格式，以便在后续的数据处理过程中使用时间戳。还计算了移动平均线和基本面指标，如市盈率和市净率等。
数据分割：将数据集分为训练集和测试集。我们将前80%的数据作为训练集，后20%的数据作为测试集。
数据标准化：使用StandardScaler函数对训练集和测试集进行标准化处理，使用Z-score函数对数据的均值和标准差进行标准化，以便在深度学习模型中使用。
Z-score：
数据除噪：中值滤波的信号去噪，并绘制了原始数据和去噪后的数据的柱状图，如图3.1。中值滤波是一种通过排序统计的信号来去除数据中的离群值的噪音，可以在有效的去除信号中的噪音和离群值的同时保留信号的趋势与特征。

图3.1 原始数据和去噪后的数据
3.3 特征工程
上文中说到，我对原始数据进行了预处理和清洗，并对数据进行了初始化的操作，本节通过对预处理好的数据使用特征转换、特征构建、特征选择三个方面进行特征工程。
3.3.1特征转换
特征转化作为特征工程里一项关键的步骤，可以将原始数据转换为适合深度学习算法使用的特征表示。实现本文通过从date日期时间数据提取出年、月、日信息，然后在对数值型特征使用缩放处理，由于使用了随机森林算法计算特征重要性，所以还有高维特征进行了特征降维，以此来提高模型的性能和泛化能力，减少计算复杂度和过拟合。






3.3.2特征构建
如表3.2所示，第二栏变量是对股票市场表现有影响的宏观经济变量，可以更多的表现股票预测的潜在信息，我选择了恐慌指数、利率指数、失业率、消费者信心等因素可能成为影响股票市场的潜在信息，由于中国的失业率数据没有具体的每月进行统计，利率数据统计量太小，研究的准确性和可信度有限，所以失业率和利率并没有加入研究，但这两个指标对股票市场的表现也有一定影响。
VIX衡量上证综合指数未来30天波动率预期的指标，也被称为“恐慌指数”。VIX 指数越高，表示市场的波动性越大，投资者的恐慌情绪也越高。因此，VIX 指数通常被用作衡量市场风险的指标。
消费者信心指数（cncci）是一种经济指标，用于衡量消费者对当前和未来经济状况的信心水平。它通常由各种调查机构通过对消费者进行问卷调查获得，根据Akshare查询得到本文所用数据来源于东方财富网。消费者信心指数通常是一个定量指标，其数值范围通常在0到200之间，具体取决于不同的调查机构和国家。一般来说，当消费者信心指数高于某个阈值时，表示消费者对经济状况感到乐观，可能会增加消费和投资，从而促进经济增长；反之，当消费者信心指数低于某个阈值时，表示消费者对经济状况感到悲观，可能会减少消费和投资，从而拖累经济增长。消费者信心指数通常被视为一个重要的经济晴雨表，因为它可以提供有关消费者行为和经济趋势的信息，有助于政策制定者、企业和投资者做出决策。同时，由于消费者信心指数是由消费者的自我感受和预期构成的，因此其具有一定的主观性，需要结合其他经济指标一起分析。
市场波动率（volatility）是指市场价格波动的程度和频率。在金融市场中，市场波动性通常被用作衡量市场风险和不确定性的指标。市场波动性的高低对投资者和交易者都有重要的影响。当市场波动性较高时，投资者和交易者可能会更加谨慎，从而减少交易量和投资额，这可能会导致市场价格下跌。反之，当市场波动性较低时，投资者和交易者可能会更加乐观，从而增加交易量和投资额，这可能会推动市场价格上涨。在金融市场中，市场波动性通常被视为一个重要的风险指标，因此投资者和交易者需要密切关注市场波动性的变化，并采取相应的交易策略来管理风险。本文计算历史波动率时，使用了滚动窗口进行计算，即每个时间点的波动率是基于一段历史时间内的指数收益率计算得出的，
	数据									来源		频率		缩略
	基础数据								
	开盘价格								Akshare		每天		........
	收盘价格 								Akshare		每天		........
   	........								........	........	........
	宏观经济
	恐慌指数 								......		每天		VIX
	消费者信心指数                         Akshare     每天		CNCCI
	市场波动性								......		每天		volatility
	技术指标
	移动平均收敛散度						......		每天		MACD
	平均真实波动幅度						......		每天		ATR
	相对强度指数							......		每天		RSI
表3.2 模型的潜在特征列表
在表3.2中的最后一组变量是技术指标，本文选择了移动平均敛散度（MACD）、平均真实波动幅度（ATR）和相对强度指数（RSI）。技术指标可以帮助投资者和交易者更好地理解市场价格的动态和趋势，并提供交易决策的参考依据。
移动平均敛散度（MACD），计算短期和长期的EMA，然后计算DIF和DEA，最后MACD等于DIF减去DEA。当MACD柱形图的数值变大时，通常表示市场价格的动量增强，价格趋势可能会加速；反之，当MACD柱形图的数值变小时，通常表示市场价格的动量减弱，价格趋势可能会放缓或逆转
平均真实波动幅度，ATR是（真实波幅）TR的移动平均值，通常计算14个周期的移动平均。周期数较短，ATR指标将更加敏感，反映出较短期内的价格波动；周期数较长，ATR指标将更加平滑，反映出较长期内的价格波动。
相对强度指数（RSI）用于测量股票或其他资产的价格动量和强度。它通常用于研究股票或市场的超买和超卖情况。



3.3.3特征选择
上文中分别介绍了特征工程中所使用的参数和指标对股票的影响作用。如图3.2，通过对输入特征进行了相关性计算并将结果进行热力可视化。热图中的数值表示水平轴和垂直轴上变量之间的相关性。其中，每个方格的颜色表示对应特征之间的相关性强度，颜色越深表示相关性越强，颜色越浅表示相关性越弱。而每个方格里的数字则表示对应特征之间的相关系数，取值范围在-1到1之间，其中正数表示正相关，负数表示负相关，0表示无相关性。
通过观察热力图，可以发现open、close、high、low和volume特征之间存在较强的相关性。这是因为这些特征都与股票价格和成交量相关，而价格和成交量通常会互相影响。例如，当价格上涨时，成交量通常也会上涨；而当成交量增加时，价格也可能会上涨。在各个宏观经济指标中，cncci与close相关性与最高，因此，消费者信心指数可能在收盘价格预测中发挥相当主要的作用。同样的解释适用于图中显示的其他特征。


图3.2 归因变量间的相关热力图
如图3.3所示，散点矩阵分别按照收盘价、交易量、移动平均线收敛/发散指标、相对强弱指标、平均真实波幅和消费者信心排列，技术指标中ATR和RSI对于收盘价都有非常不错的相关性，并针对RSI绘制了双y轴图（图3.4），以观察收盘价与RSI指标随时间变化的发展趋势，更加直观的看到平均真实波动幅度对股市的影响。


图3.3 散点矩阵图

图3.4 收盘价与RSI指标随时间变化
4.1 模型架构设计
4.1.1 CNN模型的设计和实现
本研究针对金融时间序列数据的特点，设计了一种基于一维卷积神经网络（1D CNN）的模型结构，如图4.1所示。
图4.1
在该模型中，考虑到金融数据在不同维度上的表现，本文用tn表示预测时要参考的时间维度数量，fn为每个时间维度下的特征维度数量。输入金融数据经过三个不同尺寸的卷积层，每个卷积层使用不同大小的卷积核对输入数据进行卷积操作，提取输入数据中的特征，激活函数为ReLU。这个模型使用了多个不同尺寸的卷积层和全连接层，可以从不同尺度上提取输入数据中的特征，从而提高了模型的表达能力。卷积层的输出经过池化层，对其进行下采样，减少输出数据的维度。池化层的输出经过展平操作，将其转换为一维向量。通过池化和展平操作，可以将输入数据转换为一维向量，减少了计算量和参数数量，从而加速了训练和推理。 经过三个不同尺寸的全连接层，每个全连接层包含 64 个神经元，对其进行线性变换。三个全连接层的输出经过相加操作，将它们加权相加，得到一个长度为 64 的一维向量。这个向量经过输出层的线性变换，得到一个包含一个神经元的输出，表示模型预测的连续数值。使用了线性激活函数，可以保持输出的连续性，有利于回归问题的求解。
该模型通过不同大小的卷积核提取金融数据在不同时间尺度上的特征关联信息，从而在预测和分析金融数据方面具有重要意义。与实证分析中的方形尺寸卷积核CNN模型相比，本研究构建的基于1D CNN的模型能够更有效地提取金融数据的特征。此外，增加卷积层的数量可以进一步提高模型性能。
4.1.2 RNN模型的设计和实现
循环神经网络（Recurrent Neural Network，RNN）是一种常用于处理序列数据的神经网络模型。与其他前馈神经网络不同，RNN 在处理序列数据时，具有记忆能力，可以将之前处理的信息传递到下一步，从而在处理序列数据时具有更好的性能。

图 4.2 RNN循环神经网络图
本文将介绍如何使用RNN（循环神经网络）模型进行时间序列预测，以股票收盘价为例。首先，我们读取股票数据并进行预处理，包括将数据归一化和创建时间序列数据集。然后，我们创建一个包含三个SimpleRNN层和一个密集层的序列模型，并使用Adam优化器和均方误差损失函数进行训练。我们使用训练数据来训练模型，并使用测试数据进行评估。最后，我们将预测结果可视化，并计算模型的RMSE、MAE和R2得分。
首先读取股票数据，并将其缩放到0-1的范围内，以便于模型的训练和预测。我们还将数据重塑为一个时间序列数据集，以便于使用RNN模型进行时间序列预测。创建一个包含三个SimpleRNN层和一个Dense层的序列模型。每个SimpleRNN层都包含一个ReLU激活函数和一个Dropout层，以避免过拟合。最后一个密集层输出一个值，用于预测下一个时间步的股票收盘价。根据RNN的运行机制特点，RNN 模型可以表示为：

其中，Ht表示在时间步长t的隐状态，Xt表示在时间步t的输入，Wxh表示隐藏层的权重，bh表示为隐藏层的偏差参数是激活函数。
在训练 RNN 模型时，采用了反向传播算法（Backpropagation Through Time，BPTT）进行优化。在 BPTT 算法中，将 RNN 模型展开成一个前馈神经网络，然后计算损失函数关于每个时间步的参数的梯度，最后通过梯度下降算法更新参数。
最后使用训练数据来评估模型，并使用测试数据进行预测。我们将预测结果反归一化，以便于比较真实值和预测值。最后，我们计算模型的RMSE、MAE和R2得分，并将预测结果可视化。
4.1.3 LSTM模型的设计和实现
上文中说到使用RNN（循环神经网络）进行时间序列预测，本节将继续探讨另外一个基于时间序列预测模型——LSTM，对比循环神经网络，长短期记忆神经网络在春来长序列和长期依赖关系方面的能力会更强，因为RNN在实际以实际运用中，记忆的信息会由于时间间隔太长，信息的传递能力逐渐开始减弱。在长序列处理时，RNN可能会出现梯度爆炸或者梯度消失导致无法保持信息间的长期依赖关系。LSTM通过引入门控制机制，一定程度上有效的解决了此类问题，让模型在长时间序列预测上具有良好的表现。
在LSTM模型中，模型会对每个特征进行权重分配，以确定每个特征在预测目标变量的相对重要性，这个权重的分配是通过每个LSTM单元内部的门控制单元来实现的，一共有4个门控制器，分别是遗忘门、输入门、候选记忆细胞、输出门。对于给定的输入序列{x1，x2，…，xn}，xt∈Rk×d是时间t的输入序列，
Ht-1∈Rh×n是上一时间步隐藏状态。It为输入门，Ft遗忘门，Ot为输出门，候选记忆细胞是，ct为当前时间步记忆细胞。在时刻t，相应的门和层计算以下函数:
It=

,
,
,
,
其中，𝜎和tanh分别表示sigmoid函数和双曲正切函数，算子⊗为元素乘积，𝑊x∈R𝑑×h ,𝑊ℎ∈Rh×h为权重参数，𝑏∈Rh×1为偏差参数。此外，𝑛，d，h分别是序列长度，特征数量和隐藏大小。如图4.3所示的LSTM中的隐状态计算。

图4.3 长短期记忆中的隐藏状态的计算
由于考虑到LSTM在使用多特征下的效果会比其他模型效果更好，本文使用了三个模型来探讨LSTM的股票预测的效果，分别是在单特征情况下的股票预测、多特征情况下的股票预测、引入self-attention自注意力机制的LSTM模型。
在模型实现上，均先使用了MinMaxScaler对数据进行了归一化处理，然后将数据按时间顺序分为训练集和测试集。在数据输入方面，单特征选取的收盘价为输入送进模型开始训练，单特征LSTM模型包含了一个简单的LSTM层和全连接层，在调试过程中，在数据集形状为（7866，1）的条件下，简单的模型预测效果比复杂的反而更好，多特征选取了收盘价、交易量、消费者信心指数、atr等特征指标送入模型，在模型中我们增加了更多的LSTM层的个数并尝试加入了卷积层和池化层，进一步的改进了模型的性能，最后输出层只有一个对close收盘价的输出。为了更近一步的探讨和强化模型的效果，本文添加了一个tansformer模型里的self-attention机制引入到LSTM模型，将self-attention机制和LSTM结合可以在多个NLP任务中提高模型的性能，Self-attention机制可以帮助模型在处理长序列数据时更好地捕捉序列中的关系和依赖关系。LSTM则可以利用其门控机制来控制信息的流动，从而更好地处理长序列数据中的长期依赖问题。将这两种机制结合起来，可以进一步提高模型对长序列数据的建模能力。具体实现上，可以在LSTM的每个时间步中引入self-attention机制。在每个时间步，可以将LSTM的输出作为self-attention的输入，然后通过self-attention来计算每个时间步的重要性权重。这些权重可以用来加权LSTM的输出，从而获得更好的表示。最终，可以将加权后的LSTM输出作为模型的最终输出。但需要注意的是，由于引入了self-attention机制，模型的计算量会增加，因此需要对模型进行一定的优化，例如使用多头注意力机制、缩放点积注意力等技术来减少计算量。

4.1.4 GRU模型的设计和实现
GRU（门控制循环神经网络），相比较与其他标准的神经网络，GRU内部有一个重置门和一个更新门，所以GRU区别于其他循环神经网络具有更强的记忆能力和更好的长期依赖。因为GRU可以做到在控制前段的信息在当前时刻的遗忘程度并且还能控制当前时刻的input和之前的隐藏状态在当前时刻的重要性。
重置门和更新门均由sigmoid函数计算得出，是一种特殊的逻辑函数，它的公式是：

本文将股票数据输入到一个用Sequential（）的函数中创建空的蓄力模型，使得可以通过add（）函数不断添加系列层来构建模型并是模型后期优化更加方便简易。第一层设置了一个GRU层并输入一定量的单元数，通过使用return_sequences参数设置True，使得最后输出完整的序列，接着数据进入Dropout层，减少过拟合的可能性，通过以一定的概率随机地将一些神经元的输出设置为零来防止神经元之间的过度拟合和依赖性。同理再循环以上操作两次。在模型构建后，通过compile()函数来编译模型，其中指定了优化器为Adam，损失函数为均方误差（mean_squared_error）。
在这个模型中，第一个GRU层的输出序列作为第二个GRU层的输入，第二个GRU层的输出序列作为第三个GRU层的输入。最后一个GRU层的输出序列被馈送到一个全连接层，生成模型的输出。这种层与层之间的线性堆叠方式是典型的深度神经网络的构建方式之一，也被称为串联模型。
LSTM-GRU模型
4.2 模型训练和验证
首先，准备好股票数据将其读取为一个df的表存储。然后，将数据分为训练集和测试集，采用80%的数据作为训练集，20%的数据作为测试集。最后对数据进行归一化处理，将数据范围缩放到0到1之间。
每个样本包含n个时间步的数据和一个标签（下一个时间步的数据）。使用create_dataset函数来完成这个任务。在这个函数中，需要指定时间步长，即每个样本包含多少个时间步的数据。然后，可以用这个函数来创建训练集和测试集。
epochs表示模型训练的轮数，即整个数据集将被训练多少次。在每个 epoch 中，模型会遍历一次整个训练集。通常来说，训练轮数越多，模型的性能就越好，但也会带来过拟合的风险。batch_size表示每次迭代训练时，模型从训练集中选择的样本数。在每个 epoch 中，训练集会被分成若干个大小相等的 batch，模型会对每个 batch 进行一次前向传播和反向传播，从而更新模型的参数。通常来说，较大的 batch_size 可以提高训练速度，但也会占用更多的内存。verbose表示输出训练过程中的信息量。当设置为 0 时，模型将不会输出任何信息；当设置为 1 时，模型将输出进度条和每个 epoch 的训练时间；当设置为 2 时，模型将在每个 epoch 结束后输出一条训练信息。
设置输入形状、模型的神经元数量、全连接层的输出维度以及损失函数和优化器等参数后，使用训练集来训练模型。在这个过程中，需要指定迭代次数、批大小和超参数，以控制训练的速度和输出信息。训练完成后，可以保存模型到一个.h5文件中。接下来，使用训练好的模型来预测测试集。在这个过程中，需要将输入数据传递给模型，并将预测结果反归一化处理，以还原为原始价格范围。
反归一化处理在模型的验证过程中是一个重要的步骤，可以将模型预测的结果还原到原始数据的数值范围，使得结果更加直观和易于理解，从而提高模型的可解释性。在一些数据范围较大的场景中，模型可能会因为数据的变化而导致预测结果的不稳定性。反归一化处理可以将模型预测的结果还原到原始数据的数值范围，从而减少数据变化对模型预测结果的影响，增强模型的稳定性。
4.3 模型性能评估指标
基于项目是对时间序列数据进行回归预测分析，本文选取了MSE、RMSE、MAE、R2和相关系数（R）五个指标来评估这些模型的预测精准度和可靠性，这些指标的公式如下：




𝑦𝑖:原始时间序列，:原始时间序列的平均值，:由模型计算得到的预测时间序列，:预测时间序列的平均值，𝑁:观测数。R2为R的平方。RSME是均方误差，用于预测值与真实值之间差异的平方的平均值，可以衡量模型的预测误差大小。RMSE越小，代表模型预测越准确。MSE是均方根误差，也就是RSME的平方根，与均方误差类似。MAE是平均绝对误差，用于预测值与真实值之间差异的绝对值的平均值，衡量模型的预测误差大小，MAE越小，代表模型预测越准确，相比于MSE指标，MAE更加容易理解和解释，因为它不涉及误差的平方，可以直接反映出误差的绝对大小。R2（R-Squared）用于衡量模型对数据的拟合程度。R2的取值范围在0到1之间，表示模型可以解释数据方差的比例。R是相关系数，用于衡量两个变量之间的线性关系强度及方向，其取值范围在-1到1之间。
